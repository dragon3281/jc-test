# 自动化数据检测平台 - 持久化部署完成报告

## 📅 部署信息

- **部署日期**: 2025-12-09
- **部署方式**: nohup后台运行
- **服务器**: 103.246.246.4
- **部署人员**: AI助手

## ✅ 完成项目

### 1. WebSocket心跳保活机制

#### 后端优化

**文件**: `backend/src/main/resources/application.yml`
```yaml
server:
  tomcat:
    connection-timeout: 60000      # 连接超时60秒
    keep-alive-timeout: 60000      # Keep-Alive超时60秒
    max-keep-alive-requests: 100   # 最大Keep-Alive请求数
```

**文件**: `backend/src/main/java/com/detection/platform/config/WebSocketConfig.java`
```java
registry.enableSimpleBroker("/topic", "/queue")
        .setHeartbeatValue(new long[] {10000, 10000});  // 心跳间隔10秒
```

#### 前端优化

**文件**: `frontend/src/utils/websocket.js`
- ✅ 添加心跳定时器(20秒间隔)
- ✅ 自动发送心跳ping
- ✅ 断线自动重连(3秒延迟)
- ✅ 连接状态监控

**关键特性**:
```javascript
// 心跳间隔20秒
this.heartbeatInterval = 20000

// 自动重连延迟3秒
this.reconnectDelay = 3000

// 启动心跳机制
startHeartbeat()

// 发送心跳ping
this.stompClient.send('/app/heartbeat', {}, JSON.stringify({ type: 'ping' }))
```

### 2. 持久化运行脚本

#### 主启动脚本

**文件**: `persistent-start.sh`
- ✅ 支持systemd和nohup两种启动方式
- ✅ 自动检测环境选择最佳方案
- ✅ 完整的启动日志
- ✅ 超时检测机制

**使用方法**:
```bash
# systemd方式(推荐)
bash /root/jc-test/persistent-start.sh systemd

# nohup方式(当前使用)
bash /root/jc-test/persistent-start.sh nohup

# 自动选择
bash /root/jc-test/persistent-start.sh
```

#### 停止服务脚本

**文件**: `stop-services.sh`
- ✅ 智能检测运行方式
- ✅ 完全清理进程
- ✅ 端口释放验证

**使用方法**:
```bash
bash /root/jc-test/stop-services.sh
```

#### 健康监控脚本

**文件**: `health-check.sh`
- ✅ Docker服务检查
- ✅ 前后端服务检查
- ✅ WebSocket连接测试
- ✅ 系统资源监控
- ✅ 日志文件检查

**使用方法**:
```bash
# 手动执行
bash /root/jc-test/health-check.sh

# 定时执行(可选)
# 每5分钟检查一次
*/5 * * * * /bin/bash /root/jc-test/health-check.sh >> /root/jc-test/logs/health-check.log 2>&1
```

### 3. systemd服务配置文件

#### 后端服务

**文件**: `detection-backend.service`
- ✅ 开机自启
- ✅ 异常自动重启
- ✅ JVM内存优化
- ✅ 日志自动管理

**配置**:
```ini
[Service]
Restart=always
RestartSec=10
ExecStart=/usr/bin/java -jar -Xms512m -Xmx2048m -XX:+UseG1GC ...
```

#### 前端服务

**文件**: `detection-frontend.service`
- ✅ 开机自启
- ✅ 异常自动重启
- ✅ 依赖自动检查
- ✅ 日志自动管理

**配置**:
```ini
[Service]
Restart=always
RestartSec=10
ExecStart=/usr/bin/npm run dev
```

## 🚀 当前运行状态

### 服务状态

```
✅ 后端服务: 运行中
   - 端口: 8080
   - PID: 171386
   - 进程: java (263MB jar包)
   - 内存: 512MB-2048MB
   - 启动方式: nohup

✅ 前端服务: 运行中
   - 端口: 3000
   - PID: 169922
   - 进程: node (vite)
   - 启动方式: nohup

✅ WebSocket: 可用
   - 端点: ws://103.246.246.4:8080/ws
   - 心跳: 10秒(服务端) / 20秒(客户端)
   - 自动重连: 3秒延迟

✅ Docker服务: 运行中
   - MySQL: detection-mysql (3306)
   - Redis: detection-redis (6379)
   - RabbitMQ: detection-rabbitmq (5672, 15672)
```

### 访问地址

- **前端**: http://103.246.246.4:3000
- **后端API**: http://103.246.246.4:8080
- **RabbitMQ管理**: http://103.246.246.4:15672
- **默认账号**: admin / admin123

### 日志文件

```
/root/jc-test/logs/
├── backend-startup.log          # 后端启动日志
├── frontend-startup.log         # 前端启动日志
├── detection-platform.log       # 应用运行日志
├── backend.pid                  # 后端进程ID
└── frontend.pid                 # 前端进程ID
```

## 📊 性能优化

### 连接保持

| 配置项 | 值 | 说明 |
|--------|-----|------|
| Tomcat连接超时 | 60秒 | HTTP连接保持时间 |
| Keep-Alive超时 | 60秒 | 长连接保持时间 |
| WebSocket心跳 | 10秒 | 服务端心跳间隔 |
| 客户端心跳 | 20秒 | 前端心跳发送间隔 |
| 自动重连延迟 | 3秒 | 断线后重连等待时间 |

### JVM配置

| 参数 | 值 | 说明 |
|------|-----|------|
| 初始堆内存 | 512MB | -Xms512m |
| 最大堆内存 | 2048MB | -Xmx2048m |
| GC算法 | G1GC | -XX:+UseG1GC |
| GC暂停目标 | 200ms | -XX:MaxGCPauseMillis=200 |

### 连接池配置

| 组件 | 最小 | 最大 | 说明 |
|------|------|------|------|
| HikariCP | 10 | 50 | MySQL连接池 |
| Redis | 10 | 50 | Redis连接池 |
| HTTP客户端 | - | 500 | HTTP连接池 |

## 🛠️ 管理命令

### 服务管理

```bash
# 启动服务
bash /root/jc-test/persistent-start.sh nohup

# 停止服务
bash /root/jc-test/stop-services.sh

# 健康检查
bash /root/jc-test/health-check.sh

# 查看进程
ps aux | grep -E "(java.*detection|node.*vite)"

# 查看端口
netstat -tlnp | grep -E ":(3000|8080)"
```

### 日志查看

```bash
# 实时查看后端日志
tail -f /root/jc-test/logs/backend-startup.log

# 实时查看前端日志
tail -f /root/jc-test/logs/frontend-startup.log

# 实时查看应用日志
tail -f /root/jc-test/logs/detection-platform.log

# 查看最近100行
tail -100 /root/jc-test/logs/detection-platform.log

# 搜索错误日志
grep -i "error\|exception" /root/jc-test/logs/detection-platform.log
```

### 进程管理

```bash
# 查看后端PID
cat /root/jc-test/logs/backend.pid

# 查看前端PID  
cat /root/jc-test/logs/frontend.pid

# 停止后端
kill $(cat /root/jc-test/logs/backend.pid)

# 停止前端
kill $(cat /root/jc-test/logs/frontend.pid)
```

## 🔧 故障排查

### 问题1: WebSocket频繁断开

**原因分析**:
- 网络不稳定
- 防火墙限制
- 心跳超时

**已实施的解决方案**:
- ✅ 服务端心跳间隔10秒
- ✅ 客户端心跳间隔20秒
- ✅ 自动重连机制(3秒延迟)
- ✅ Keep-Alive配置60秒

**验证**:
```bash
# 检查WebSocket日志
tail -f /root/jc-test/logs/detection-platform.log | grep -i websocket
```

### 问题2: 前端无法访问

**检查步骤**:
```bash
# 1. 检查进程
ps aux | grep vite

# 2. 检查端口
netstat -tlnp | grep 3000

# 3. 测试访问
curl -I http://localhost:3000

# 4. 查看日志
tail -50 /root/jc-test/logs/frontend-startup.log

# 5. 重启前端
pkill -f vite
cd /root/jc-test/frontend
nohup npm run dev > /root/jc-test/logs/frontend-startup.log 2>&1 &
```

### 问题3: 后端API无响应

**检查步骤**:
```bash
# 1. 检查进程
ps aux | grep detection-platform

# 2. 检查端口
netstat -tlnp | grep 8080

# 3. 测试API
curl -X POST http://localhost:8080/user/login \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"admin123"}'

# 4. 查看日志
tail -100 /root/jc-test/logs/detection-platform.log

# 5. 重启后端
bash /root/jc-test/persistent-start.sh nohup
```

## 📈 监控建议

### 1. 设置定时健康检查

```bash
# 编辑crontab
crontab -e

# 添加以下行
*/5 * * * * /bin/bash /root/jc-test/health-check.sh >> /root/jc-test/logs/health-check.log 2>&1
```

### 2. 日志轮转(防止日志过大)

```bash
# 创建logrotate配置
sudo cat > /etc/logrotate.d/detection-platform << 'EOF'
/root/jc-test/logs/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 0644 root root
}
EOF
```

### 3. 系统资源监控

```bash
# 实时查看资源使用
top -p $(cat /root/jc-test/logs/backend.pid),$(cat /root/jc-test/logs/frontend.pid)

# 查看内存使用
free -h

# 查看磁盘使用
df -h
```

## 🎯 后续建议

### 1. 升级为systemd服务(推荐)

**优势**:
- ✅ 系统级管理
- ✅ 开机自启
- ✅ 异常自动重启
- ✅ 日志集中管理

**操作方法**:
```bash
# 停止当前服务
bash /root/jc-test/stop-services.sh

# 使用systemd启动
bash /root/jc-test/persistent-start.sh systemd

# 验证服务状态
systemctl status detection-backend
systemctl status detection-frontend
```

### 2. 配置Nginx反向代理(可选)

**优势**:
- HTTPS支持
- 负载均衡
- 静态资源缓存
- 访问日志

### 3. 数据库定期备份

```bash
# 创建备份脚本
cat > /root/jc-test/backup-db.sh << 'EOF'
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
docker exec detection-mysql mysqldump -u root -p123456 detection_platform \
  > /root/jc-test/backup/db_backup_$DATE.sql
find /root/jc-test/backup -name "db_backup_*.sql" -mtime +7 -delete
EOF

chmod +x /root/jc-test/backup-db.sh

# 添加定时任务(每天凌晨2点备份)
# 0 2 * * * /bin/bash /root/jc-test/backup-db.sh
```

## 📚 相关文档

- [持久化运行说明](持久化运行说明.md)
- [快速部署指南](docs/快速部署指南.md)
- [开发指南](docs/开发指南.md)

## ✅ 验收确认

- [x] 前端服务稳定运行(端口3000)
- [x] 后端服务稳定运行(端口8080)
- [x] WebSocket心跳机制生效
- [x] 自动重连功能正常
- [x] Docker服务正常
- [x] 日志记录正常
- [x] 进程持久化运行
- [x] 管理脚本完善
- [x] 健康监控脚本可用
- [x] 文档齐全

## 🎉 总结

通过本次优化,成功解决了以下问题:

1. **WebSocket频繁掉线** → 添加心跳保活机制
2. **服务不稳定** → 实现进程持久化运行
3. **管理不便** → 提供完整的管理脚本
4. **监控缺失** → 实现健康检查功能
5. **文档缺乏** → 编写完整部署文档

当前系统已实现:
- ✅ 稳定持久运行
- ✅ 自动心跳保活
- ✅ 断线自动重连
- ✅ 完善的管理工具
- ✅ 健康监控机制

**部署状态**: 🟢 成功
**运行状态**: 🟢 正常
**可访问性**: 🟢 正常

---

**部署完成时间**: 2025-12-09 11:14  
**部署版本**: v1.0.0  
**下次检查**: 建议每日检查一次健康状态
